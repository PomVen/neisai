<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hallth.mapper.MytyAnswerMapper">
    <resultMap id="BaseResultMap" type="com.hallth.domain.MytyAnswer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="dm_id" jdbcType="INTEGER" property="dmId"/>
        <result column="user_id" jdbcType="VARCHAR" property="userId"/>
        <result column="user_answer" jdbcType="VARCHAR" property="userAnswer"/>
        <result column="user_judge" jdbcType="INTEGER" property="userJudge"/>
        <result column="is_right" jdbcType="INTEGER" property="isRight"/>
        <result column="agenda_round_no" jdbcType="INTEGER" property="agendaRoundNo"/>
    </resultMap>
    <insert id="insert" parameterType="com.hallth.domain.MytyAnswer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into myty_answer (dm_id, user_id, user_answer,
        user_judge, is_right, agenda_round_no)
        values (#{dmId,jdbcType=INTEGER}, #{userId,jdbcType=VARCHAR}, #{userAnswer,jdbcType=VARCHAR},
        #{userJudge,jdbcType=INTEGER}, #{isRight, jdbcType=INTEGER}, #{agendaRoundNo, jdbcType=INTEGER})
    </insert>
    <insert id="insertSelective" parameterType="com.hallth.domain.MytyAnswer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into myty_answer
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="dmId != null">
                dm_id,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="userAnswer != null">
                user_answer,
            </if>
            <if test="userJudge != null">
                user_judge,
            </if>
            <if test="isRight != null">
                is_right,
            </if>
            <if test="agendaRoundNo != null">
                agenda_round_no,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="dmId != null">
                #{dmId,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=VARCHAR},
            </if>
            <if test="userAnswer != null">
                #{userAnswer,jdbcType=VARCHAR},
            </if>
            <if test="userJudge != null">
                #{userJudge,jdbcType=INTEGER},
            </if>
            <if test="isRight != null">
                #{isRight, jdbcType=INTEGER},
            </if>
            <if test="agendaRoundNo != null">
                #{agendaRoundNo, jdbcType=INTEGER},
            </if>
        </trim>
    </insert>

    <sql id="Base_Column_List">
        dm_id, user_id, user_answer, user_judge, is_right, agenda_round_no
    </sql>

    <update id="updateMyAnswer" parameterType="com.hallth.domain.MytyAnswer">
        update myty_answer
            set user_answer = #{userAnswer,jdbcType=VARCHAR}
        where dm_id = #{dmId,jdbcType=INTEGER} and user_id = #{userId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </update>

    <update id="updateMyJudge" parameterType="com.hallth.domain.MytyAnswer">
        update myty_answer
            set user_judge = #{userJudge,jdbcType=INTEGER}
        where dm_id = #{dmId,jdbcType=INTEGER} and user_id = #{userId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </update>

    <update id="updateIsRight" parameterType="com.hallth.domain.MytyAnswer">
        update myty_answer
            set is_right = #{isRight,jdbcType=INTEGER}
        where dm_id = #{dmId,jdbcType=INTEGER} and user_id = #{userId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </update>

    <select id="selectAnswer" parameterType="com.hallth.domain.MytyAnswer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from myty_answer
        where user_id = #{userId,jdbcType=INTEGER} and dm_id = #{dmId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </select>

    <select id="getInputAnswerCounts" parameterType="com.hallth.domain.MytyAgenda" resultType="com.hallth.domain.SaikuangBean">
        select A.user_id, B.user_name, count(A.user_answer) as count from myty_answer A
        left join myty_user B on A.user_id = B.user_id
        where agenda_round_no = #{roundNo, jdbcType=INTEGER}
        group by A.user_id HAVING  count(A.user_answer)  > 0
    </select>

    <select id="getJudgeCounts" parameterType="com.hallth.domain.MytyAgenda" resultType="com.hallth.domain.SaikuangBean">
        select A.user_id, B.user_name, count(A.user_judge) as count from myty_answer A
        left join myty_user B on A.user_id = B.user_id
        where agenda_round_no = #{roundNo, jdbcType=INTEGER}
        group by A.user_id HAVING  count(A.user_judge)  > 0
    </select>


    <select id="getAnswerScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select temp.agenda_round_no, temp.user_name, sum(temp.answer_judge) as right_count, sum(answer_score) as user_answer_score, temp.user_id
        from (select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name, a.user_id, a.user_answer, dm.dm_midi,
         case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
         case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
        from myty_dengmi_temp dm
        left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
        order by a.user_id) temp
        group by temp.user_name
        order by user_answer_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getAnswerScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(distinct temp.user_name)
        from (select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name, a.user_answer, dm.dm_midi,
         case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
         case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
        from myty_dengmi_temp dm
        left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
        order by a.user_id) temp
    </select>

    <select id="getSubjectScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select u2.user_name as dm_author_name, u2.user_id as dm_author_id, sum(a.user_judge) as user_subject_score, dm.agenda_round_no
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
        left join myty_user u2 on u2.user_id = dm.dm_author
        where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
        group by dm.dm_author
        order by user_subject_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getSubjectScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(distinct u2.user_name)
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
        left join myty_user u2 on u2.user_id = dm.dm_author
        where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
    </select>

    <select id="getThisScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select t1.agenda_round_no, t1.user_id, t1.user_name, t1.right_count, t1.user_answer_score, t2.user_subject_score, t1.user_answer_score + t2.user_subject_score as sum_score
        from (
            select temp.agenda_round_no, temp.user_name,temp.user_id, sum(temp.answer_judge) as right_count, sum(answer_score) as user_answer_score
            from (
                select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name,u2.user_id, a.user_answer, dm.dm_midi,
                case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
                case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
                from myty_dengmi_temp dm
                left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
                left join myty_user u1 on u1.user_id = dm.dm_author
                left join myty_user u2 on u2.user_id = a.user_id
                where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
                order by a.user_id
            ) temp
            group by temp.user_name
        ) t1
        left join (
            select u2.user_id, u2.user_name as dm_author_name, sum(a.user_judge) as user_subject_score
            from myty_dengmi_temp dm
            left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
            left join myty_user u2 on u2.user_id = dm.dm_author
            where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
            group by dm.dm_author
            order by user_subject_score desc
        ) t2 on t1.user_id = t2.user_id
        where t1.user_id is not null
        order by sum_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getThisScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(*)
        from
        (select temp.agenda_round_no, temp.user_name,temp.user_id, sum(temp.answer_judge) as right_count, sum(answer_score) as user_answer_score
        from (select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name,u2.user_id, a.user_answer, dm.dm_midi,
                     case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
                     case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
              from myty_dengmi_temp dm
                     left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
                     left join myty_user u1 on u1.user_id = dm.dm_author
                     left join myty_user u2 on u2.user_id = a.user_id
              where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
              order by a.user_id) temp
        group by temp.user_name) t1
        left join (
                  select u2.user_id, u2.user_name as dm_author_name, sum(a.user_judge) as user_subject_score
                  from myty_dengmi_temp dm
                         left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
                         left join myty_user u2 on u2.user_id = dm.dm_author
                  where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
                  group by dm.dm_author
                  order by user_subject_score desc
            ) t2 on t1.user_id = t2.user_id
            where t1.user_id is not null
    </select>

    <select id="getCountScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select tt.times, tt.userAnsScore as user_answer_score, tt.userSubScore as user_subject_score, tt.user_id,
        tt.user_name , tt.userSubScore+tt.userAnsScore as sum_score,
               tt.userAnsScore/tt.times as avg_answer_score,
               tt.userSubScore/tt.times as avg_subject_score,
               (tt.userSubScore+tt.userAnsScore)/tt.times as avg_sum_score
        from (
        select sum(temp.user_ans_score) as userAnsScore,
               sum(temp.user_sub_score) as userSubScore,
               sum(temp.Imin) as times,temp.user_id,temp.user_name from (
        select s.user_id,
               case when s.user_ans_score is null then 0 else s.user_ans_score end as user_ans_score,
               case when s.user_sub_score is null then 0 else s.user_sub_score end as user_sub_score,
               u.user_name, 1 as Imin
        from myty_score s
        left join myty_user u on u.user_id = s.user_id) temp
        group by temp.user_id
        ) tt
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getCountScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(*)
        from (
        select sum(temp.user_ans_score) as userAnsScore,
               sum(temp.user_sub_score) as userSubScore,
               sum(temp.Imin) as times,temp.user_id,temp.user_name from (
        select s.user_id,
               case when s.user_ans_score is null then 0 else s.user_ans_score end as user_ans_score,
               case when s.user_sub_score is null then 0 else s.user_sub_score end as user_sub_score,
               u.user_name, 1 as Imin
        from myty_score s
        left join myty_user u on u.user_id = s.user_id) temp
        group by temp.user_id
        ) tt
    </select>

    <select id="userScoreDetailTable" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select
        s.user_id, u.user_name as dm_author_name,s.agenda_round_no,
        sum(s.user_ans_score) as user_answer_score,
        sum(s.user_sub_score) as user_subject_score
        from myty_score s
        left join myty_user u on u.user_id = s.user_id
        where s.user_id = #{dm_author_id, jdbcType=VARCHAR}
    </select>

    <select id="userAnswerDetailTable" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select dm.dm_mimian,dm.dm_mimu,dm.dm_midi,dm.dm_mimianzhu,dm.dm_midizhu,dm.dm_author as dm_author_id, u1.user_name as dm_author_name, a.user_answer,
        u2.user_name, a.user_id,
        case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end as user_answer_score
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id=dm.dm_temp_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER} and a.user_id = #{user_id, jdbcType=VARCHAR}
        order by dm.dm_temp_id
        limit #{startRow}, #{pageSize}
    </select>
    <select id="userAnswerDetailTableCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select
        count(*)
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id=dm.dm_temp_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER} and a.user_id = #{user_id, jdbcType=VARCHAR}
    </select>

    <select id="dengmiAnswerDetailTable" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select a.user_id, a.user_answer,u.user_name,
        case when a.user_answer=dm.dm_midi then '中' when a.is_right = 1 then '列中' else '不中' end as result,
        a.user_judge,
        case when a.user_answer=dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end as user_answer_score
        from myty_answer a
        left join myty_dengmi_temp dm on a.dm_id = dm.dm_temp_id
        left join myty_user u on u.user_id = a.user_id
        where dm.dm_temp_id=#{dm_id, jdbcType=INTEGER}
        limit #{startRow}, #{pageSize}
    </select>

    <select id="dengmiAnswerDetailTableCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select
        count(*)
        from myty_answer a
        left join myty_dengmi_temp dm on a.dm_id = dm.dm_temp_id
        where dm.dm_temp_id=#{dm_id, jdbcType=INTEGER}
    </select>

    <select id="getPlayerAnswerDetails" parameterType="com.hallth.domain.MytyLog" resultType="com.hallth.domain.ScoreQueryBean">
        select dm.dm_temp_id as dm_id,dm.agenda_round_no,u1.user_name as dm_author_name,u1.user_id as dm_author_id,
            SUM(case when a.user_answer = dm.dm_midi OR a.is_right = 1 then 1 else 0 end) as right_count
            , u2.user_id as user_id, u2.user_name as user_name
        from myty_dengmi_temp dm
        left join myty_answer a on a.dm_id= dm.dm_temp_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where  a.agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
        group by a.user_id , dm.dm_author
    </select>

    <select id="getAllPlayers" parameterType="com.hallth.domain.MytyLog" resultType="java.lang.String">
        select distinct user_id from myty_answer where agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </select>


    <select id="getUserSubjectScoreDetail" parameterType="com.hallth.domain.MytyLog" resultType="com.hallth.domain.MytyScore">
        select u2.user_name, u2.user_id as userId, sum(a.user_judge) as userSubScore, dm.agenda_round_no as agendaRoundNo, '2' as scoreType
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
        left join myty_user u2 on u2.user_id = dm.dm_author
        where a.agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
        group by dm.dm_author
    </select>
</mapper>