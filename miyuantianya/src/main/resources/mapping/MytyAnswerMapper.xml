<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hallth.mapper.MytyAnswerMapper">
    <resultMap id="BaseResultMap" type="com.hallth.domain.MytyAnswer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="dm_id" jdbcType="INTEGER" property="dmId"/>
        <result column="user_id" jdbcType="VARCHAR" property="userId"/>
        <result column="user_answer" jdbcType="VARCHAR" property="userAnswer"/>
        <result column="user_judge" jdbcType="INTEGER" property="userJudge"/>
        <result column="is_right" jdbcType="INTEGER" property="isRight"/>
        <result column="agenda_round_no" jdbcType="INTEGER" property="agendaRoundNo"/>
    </resultMap>
    <insert id="insert" parameterType="com.hallth.domain.MytyAnswer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into myty_answer (dm_id, user_id, user_answer,
        user_judge, is_right, agenda_round_no)
        values (#{dmId,jdbcType=INTEGER}, #{userId,jdbcType=VARCHAR}, #{userAnswer,jdbcType=VARCHAR},
        #{userJudge,jdbcType=INTEGER}, #{isRight, jdbcType=INTEGER}, #{agendaRoundNo, jdbcType=INTEGER})
    </insert>
    <insert id="insertSelective" parameterType="com.hallth.domain.MytyAnswer">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into myty_answer
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="dmId != null">
                dm_id,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="userAnswer != null">
                user_answer,
            </if>
            <if test="userJudge != null">
                user_judge,
            </if>
            <if test="isRight != null">
                is_right,
            </if>
            <if test="agendaRoundNo != null">
                agenda_round_no,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="dmId != null">
                #{dmId,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=VARCHAR},
            </if>
            <if test="userAnswer != null">
                #{userAnswer,jdbcType=VARCHAR},
            </if>
            <if test="userJudge != null">
                #{userJudge,jdbcType=INTEGER},
            </if>
            <if test="isRight != null">
                #{isRight, jdbcType=INTEGER},
            </if>
            <if test="agendaRoundNo != null">
                #{agendaRoundNo, jdbcType=INTEGER},
            </if>
        </trim>
    </insert>

    <sql id="Base_Column_List">
        dm_id, user_id, user_answer, user_judge, is_right, agenda_round_no
    </sql>

    <update id="updateMyAnswer" parameterType="com.hallth.domain.MytyAnswer">
        update myty_answer
            set user_answer = #{userAnswer,jdbcType=VARCHAR}
        where dm_id = #{dmId,jdbcType=INTEGER} and user_id = #{userId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </update>

    <update id="updateMyJudge" parameterType="com.hallth.domain.MytyAnswer">
        update myty_answer
            set user_judge = #{userJudge,jdbcType=INTEGER}
        where dm_id = #{dmId,jdbcType=INTEGER} and user_id = #{userId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </update>

    <update id="updateIsRight" parameterType="com.hallth.domain.MytyAnswer">
        update myty_answer
            set is_right = #{isRight,jdbcType=INTEGER}
        where dm_id = #{dmId,jdbcType=INTEGER} and user_id = #{userId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </update>

    <select id="selectAnswer" parameterType="com.hallth.domain.MytyAnswer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from myty_answer
        where user_id = #{userId,jdbcType=INTEGER} and dm_id = #{dmId,jdbcType=INTEGER} and agenda_round_no = #{agendaRoundNo, jdbcType=INTEGER}
    </select>

    <select id="getInputAnswerCounts" parameterType="com.hallth.domain.MytyAgenda" resultType="com.hallth.domain.SaikuangBean">
        select A.user_id, B.user_name, count(A.user_answer) as count from myty_answer A
        left join myty_user B on A.user_id = B.user_id
        where agenda_round_no = #{roundNo, jdbcType=INTEGER}
        group by A.user_id HAVING  count(A.user_answer)  > 0
    </select>

    <select id="getJudgeCounts" parameterType="com.hallth.domain.MytyAgenda" resultType="com.hallth.domain.SaikuangBean">
        select A.user_id, B.user_name, count(A.user_judge) as count from myty_answer A
        left join myty_user B on A.user_id = B.user_id
        where agenda_round_no = #{roundNo, jdbcType=INTEGER}
        group by A.user_id HAVING  count(A.user_judge)  > 0
    </select>


    <select id="getAnswerScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select temp.agenda_round_no, temp.user_name, sum(temp.answer_judge) as right_count, sum(answer_score) as user_answer_score
        from (select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name, a.user_answer, dm.dm_midi,
         case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
         case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
        from myty_dengmi_temp dm
        left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
        order by a.user_id) temp
        group by temp.user_name
        order by user_answer_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getAnswerScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(distinct temp.user_name)
        from (select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name, a.user_answer, dm.dm_midi,
         case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
         case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
        from myty_dengmi_temp dm
        left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
        left join myty_user u1 on u1.user_id = dm.dm_author
        left join myty_user u2 on u2.user_id = a.user_id
        where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
        order by a.user_id) temp
    </select>

    <select id="getSubjectScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select u2.user_name as dm_author_name, u2.user_id as dm_author_id, sum(a.user_judge) as user_subject_score, dm.agenda_round_no
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
        left join myty_user u2 on u2.user_id = dm.dm_author
        where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
        group by dm.dm_author
        order by user_subject_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getSubjectScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(distinct u2.user_name)
        from myty_dengmi_temp dm
        left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
        left join myty_user u2 on u2.user_id = dm.dm_author
        where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
    </select>

    <select id="getThisScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select t1.agenda_round_no, t1.user_id, t1.user_name, t1.right_count, t1.user_answer_score, t2.user_subject_score, t1.user_answer_score + t2.user_subject_score as sum_score
        from (
            select temp.agenda_round_no, temp.user_name,temp.user_id, sum(temp.answer_judge) as right_count, sum(answer_score) as user_answer_score
            from (
                select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name,u2.user_id, a.user_answer, dm.dm_midi,
                case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
                case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
                from myty_dengmi_temp dm
                left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
                left join myty_user u1 on u1.user_id = dm.dm_author
                left join myty_user u2 on u2.user_id = a.user_id
                where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
                order by a.user_id
            ) temp
            group by temp.user_name
        ) t1
        left join (
            select u2.user_id, u2.user_name as dm_author_name, sum(a.user_judge) as user_subject_score
            from myty_dengmi_temp dm
            left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
            left join myty_user u2 on u2.user_id = dm.dm_author
            where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
            group by dm.dm_author
            order by user_subject_score desc
        ) t2 on t1.user_id = t2.user_id
        where t1.user_id is not null
        order by sum_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getThisScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(*)
        from
        (select temp.agenda_round_no, temp.user_name,temp.user_id, sum(temp.answer_judge) as right_count, sum(answer_score) as user_answer_score
        from (select a.agenda_round_no, a.dm_id, u1.user_name as dm_author_name, u2.user_name,u2.user_id, a.user_answer, dm.dm_midi,
                     case when (a.user_answer = dm.dm_midi OR a.is_right = 1) then 1 else 0 end answer_judge,
                     case when a.user_answer = dm.dm_midi then 3 when a.is_right = 1 then 1 else 0 end answer_score
              from myty_dengmi_temp dm
                     left join myty_answer a on dm.agenda_round_no = a.agenda_round_no and dm.dm_temp_id = a.dm_id
                     left join myty_user u1 on u1.user_id = dm.dm_author
                     left join myty_user u2 on u2.user_id = a.user_id
              where dm.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
              order by a.user_id) temp
        group by temp.user_name) t1
        left join (
                  select u2.user_id, u2.user_name as dm_author_name, sum(a.user_judge) as user_subject_score
                  from myty_dengmi_temp dm
                         left join myty_answer a on a.agenda_round_no = dm.agenda_round_no and a.dm_id = dm.dm_temp_id
                         left join myty_user u2 on u2.user_id = dm.dm_author
                  where a.agenda_round_no = #{agenda_round_no, jdbcType=INTEGER}
                  group by dm.dm_author
                  order by user_subject_score desc
            ) t2 on t1.user_id = t2.user_id
            where t1.user_id is not null
    </select>

    <select id="getCountScoreInfo" parameterType="com.hallth.domain.ScoreQueryBean" resultType="com.hallth.domain.ScoreQueryBean">
        select temp.user_id, u1.user_name, sum(temp.counts) as times, zhimi_tab.user_subject_score, caishe_tab.user_ans_score, zhimi_tab.user_subject_score + caishe_tab.user_ans_score as sum_score,
               (zhimi_tab.user_subject_score + caishe_tab.user_ans_score)/sum(temp.counts) as avg_sum_score,
               (zhimi_tab.user_subject_score)/sum(temp.counts) as avg_subject_score,
               (caishe_tab.user_ans_score)/sum(temp.counts) as avg_answer_score
        from (
            select a.agenda_round_no as agenda_round_no, a.user_id as user_id, 1 as counts from myty_answer a group by a.agenda_round_no, a.user_id
            union
            select dm.agenda_round_no as agenda_round_no, dm.dm_author as user_id, 1 as counts from myty_dengmi_temp dm group by dm.agenda_round_no, dm.dm_author
        ) temp
        left join myty_user u1 on u1.user_id = temp.user_id
        left join (select u3.user_id, u3.user_name, sum(a2.user_judge) as user_subject_score
                   from myty_dengmi_temp dm2
                          left join myty_answer a2 on a2.agenda_round_no = dm2.agenda_round_no and a2.dm_id = dm2.dm_temp_id
                          left join myty_user u3 on u3.user_id = dm2.dm_author
                   group by dm2.dm_author) zhimi_tab on zhimi_tab.user_id = temp.user_id
        left join (select ans_tab.user_id, ans_tab.user_name, sum(answer_score) as user_ans_score
                   from (select u2.user_id, u2.user_name,
                                case when a3.user_answer = dm3.dm_midi then 3 when a3.is_right = 1 then 1 else 0 end answer_score
                         from myty_dengmi_temp dm3
                                left join myty_answer a3 on dm3.agenda_round_no = a3.agenda_round_no and dm3.dm_temp_id = a3.dm_id
                                left join myty_user u2 on u2.user_id = a3.user_id
                         order by a3.user_id) ans_tab
                   where ans_tab.user_name is not null
                   group by ans_tab.user_name) caishe_tab on caishe_tab.user_id = temp.user_id
        group by temp.user_id
        order by sum_score desc
        limit #{startRow}, #{pageSize}
    </select>

    <select id="getCountScoreInfoCount" parameterType="com.hallth.domain.ScoreQueryBean" resultType="java.lang.Integer">
        select count(distinct  temp.user_id)
        from (
        select a.agenda_round_no as agenda_round_no, a.user_id as user_id, 1 as counts from myty_answer a group by a.agenda_round_no, a.user_id
        union
        select dm.agenda_round_no as agenda_round_no, dm.dm_author as user_id, 1 as counts from myty_dengmi_temp dm group by dm.agenda_round_no, dm.dm_author
        ) temp
        left join myty_user u1 on u1.user_id = temp.user_id
        left join (select u3.user_id, u3.user_name, sum(a2.user_judge) as user_subject_score
                   from myty_dengmi_temp dm2
                          left join myty_answer a2 on a2.agenda_round_no = dm2.agenda_round_no and a2.dm_id = dm2.dm_temp_id
                          left join myty_user u3 on u3.user_id = dm2.dm_author
                   group by dm2.dm_author) zhimi_tab on zhimi_tab.user_id = temp.user_id
        left join (select ans_tab.user_id, ans_tab.user_name, sum(answer_score) as user_ans_score
                   from (select u2.user_id, u2.user_name,
                                case when a3.user_answer = dm3.dm_midi then 3 when a3.is_right = 1 then 1 else 0 end answer_score
                         from myty_dengmi_temp dm3
                                left join myty_answer a3 on dm3.agenda_round_no = a3.agenda_round_no and dm3.dm_temp_id = a3.dm_id
                                left join myty_user u2 on u2.user_id = a3.user_id
                         order by a3.user_id) ans_tab
                   where ans_tab.user_name is not null
                   group by ans_tab.user_name) caishe_tab on caishe_tab.user_id = temp.user_id
    </select>
</mapper>